<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Facial - Sistema T.I.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes scan {
            0% { top: 0; }
            50% { top: calc(100% - 4px); }
            100% { top: 0; }
        }
        .scanner-line {
            animation: scan 2s linear infinite;
        }
        
        @keyframes success-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .success-animation {
            animation: success-pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 min-h-screen flex items-center justify-center p-4">
    
    <div class="w-full max-w-lg">
        <!-- Encabezado -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-purple-600 rounded-full mb-4">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
            </div>
            <h1 class="text-white text-3xl font-bold mb-2">Registro Facial</h1>
            <p class="text-purple-300">Configure su autenticaci√≥n biom√©trica</p>
        </div>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-600 text-white{% elif category == 'success' %}bg-green-600 text-white{% elif category == 'info' %}bg-blue-600 text-white{% else %}bg-yellow-600 text-black{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl p-8 shadow-2xl border border-gray-700">
            <!-- Pasos del proceso -->
            <div class="flex justify-between mb-8">
                <div class="flex flex-col items-center" id="step1">
                    <div class="w-10 h-10 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold mb-2">1</div>
                    <span class="text-xs text-gray-400">Verificar</span>
                </div>
                <div class="flex-1 flex items-center px-2">
                    <div class="h-1 w-full bg-gray-600 rounded" id="progress-line-1"></div>
                </div>
                <div class="flex flex-col items-center" id="step2">
                    <div class="w-10 h-10 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center font-bold mb-2">2</div>
                    <span class="text-xs text-gray-500">Capturar</span>
                </div>
                <div class="flex-1 flex items-center px-2">
                    <div class="h-1 w-full bg-gray-600 rounded" id="progress-line-2"></div>
                </div>
                <div class="flex flex-col items-center" id="step3">
                    <div class="w-10 h-10 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center font-bold mb-2">3</div>
                    <span class="text-xs text-gray-500">Registrar</span>
                </div>
            </div>

            <!-- Paso 1: Verificaci√≥n de credenciales -->
            <div id="seccion-verificacion">
                <h2 class="text-white text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Verifique su identidad
                </h2>
                <p class="text-gray-400 text-sm mb-6">Ingrese sus credenciales para confirmar su identidad antes de registrar su rostro.</p>
                
                <form id="formVerificacion" class="space-y-4">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Correo Electr√≥nico</label>
                        <input 
                            type="email" 
                            id="correo"
                            placeholder="correo@ejemplo.com"
                            class="w-full bg-gray-700 bg-opacity-50 text-gray-200 placeholder-gray-500 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 border border-gray-600"
                            required
                        >
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Contrase√±a</label>
                        <input 
                            type="password" 
                            id="contrasena"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            class="w-full bg-gray-700 bg-opacity-50 text-gray-200 placeholder-gray-500 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 border border-gray-600"
                            required
                        >
                    </div>
                    <button 
                        type="submit"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition"
                    >
                        Verificar Identidad
                    </button>
                </form>
            </div>

            <!-- Paso 2: Captura facial -->
            <div id="seccion-captura" class="hidden">
                <h2 class="text-white text-lg font-semibold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Capture su rostro
                </h2>
                
                <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-4 mb-4">
                    <p class="text-yellow-300 text-sm">
                        <strong>Importante:</strong> Aseg√∫rese de estar en un lugar bien iluminado y que solo su rostro aparezca en la c√°mara.
                    </p>
                </div>
                
                <!-- Informaci√≥n del usuario verificado -->
                <div id="info-usuario" class="bg-gray-700/50 rounded-lg p-3 mb-4 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-white font-medium" id="nombre-usuario">-</p>
                        <p class="text-gray-400 text-sm" id="correo-usuario">-</p>
                    </div>
                </div>
                
                <!-- Selector de modo de captura -->
                <div class="flex mb-3 bg-gray-700 rounded-lg p-1">
                    <button 
                        type="button"
                        id="btn-modo-camara"
                        onclick="cambiarModoCaptura('camara')"
                        class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200 bg-purple-600 text-white"
                    >
                        üìπ C√°mara en Vivo
                    </button>
                    <button 
                        type="button"
                        id="btn-modo-archivo"
                        onclick="cambiarModoCaptura('archivo')"
                        class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all duration-200 text-gray-400 hover:text-white"
                    >
                        üì∏ Subir Foto
                    </button>
                </div>
                
                <!-- Contenedor de la c√°mara -->
                <div id="contenedor-camara" class="relative bg-gray-900 rounded-xl overflow-hidden border-2 border-gray-600 aspect-video mb-4">
                    <video 
                        id="video" 
                        class="w-full h-full object-cover"
                        autoplay 
                        playsinline
                        muted
                    ></video>
                    
                    <canvas id="canvas" class="hidden"></canvas>
                    
                    <!-- Gu√≠a facial -->
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-44 h-56 border-2 border-dashed border-purple-400 rounded-full opacity-60"></div>
                    </div>
                    
                    <!-- Scanner -->
                    <div id="scanner" class="absolute left-0 right-0 h-1 bg-gradient-to-r from-transparent via-purple-500 to-transparent scanner-line hidden"></div>
                    
                    <!-- Estado -->
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
                        <p class="text-center text-sm text-gray-300" id="status-text">
                            Iniciando c√°mara...
                        </p>
                    </div>
                    
                    <!-- Indicador de detecci√≥n -->
                    <div id="face-indicator" class="absolute top-3 right-3 hidden">
                        <span class="flex items-center gap-1 bg-green-500/80 text-white text-xs px-2 py-1 rounded-full">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Rostro detectado
                        </span>
                    </div>
                </div>
                
                <!-- Contenedor para subir archivo (modo alternativo) -->
                <div id="contenedor-archivo" class="hidden mb-4">
                    <div class="border-2 border-dashed border-purple-400 rounded-xl p-8 text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p class="text-gray-300 mb-4">Toma una selfie o selecciona una foto</p>
                        <input 
                            type="file" 
                            id="input-archivo" 
                            accept="image/*"
                            capture="user"
                            class="hidden"
                            onchange="procesarArchivo(this)"
                        >
                        <button 
                            type="button"
                            onclick="document.getElementById('input-archivo').click()"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition"
                        >
                            üì∏ Seleccionar/Tomar Foto
                        </button>
                    </div>
                    
                    <!-- Preview de la foto seleccionada -->
                    <div id="preview-foto" class="mt-4 hidden">
                        <p class="text-gray-300 text-sm mb-2">Vista previa:</p>
                        <img id="img-preview" class="w-full rounded-xl border-2 border-purple-400" />
                    </div>
                </div>
                
                <!-- Controles -->
                <div class="flex gap-3">
                    <button 
                        type="button"
                        onclick="capturarYRegistrar()"
                        id="btn-registrar"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span id="btn-registrar-text">Capturar y Registrar</span>
                    </button>
                    <button 
                        type="button"
                        onclick="cancelar()"
                        class="px-6 bg-gray-600 hover:bg-gray-500 text-white font-medium py-3 rounded-lg transition"
                    >
                        Cancelar
                    </button>
                </div>
            </div>

            <!-- Paso 3: √âxito -->
            <div id="seccion-exito" class="hidden text-center py-8">
                <div class="inline-flex items-center justify-center w-24 h-24 bg-green-600 rounded-full mb-6 success-animation">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 class="text-white text-2xl font-bold mb-2">¬°Registro Exitoso!</h2>
                <p class="text-gray-400 mb-6">Su rostro ha sido registrado correctamente. Ahora puede usar la autenticaci√≥n biom√©trica.</p>
                <a 
                    href="{{ url_for('login') }}"
                    class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition"
                >
                    Ir al Login
                </a>
            </div>
        </div>

        <!-- Volver al login -->
        <div class="mt-6 text-center">
            <a href="{{ url_for('login') }}" class="text-gray-400 hover:text-purple-400 text-sm transition">
                ‚Üê Volver al inicio de sesi√≥n
            </a>
        </div>
    </div>

    <script>
        let stream = null;
        let idUsuarioVerificado = null;
        let modoCaptura = 'camara'; // 'camara' o 'archivo'
        let imagenCapturadaBase64 = null;
        
        // Cambiar modo de captura
        function cambiarModoCaptura(modo) {
            modoCaptura = modo;
            const contenedorCamara = document.getElementById('contenedor-camara');
            const contenedorArchivo = document.getElementById('contenedor-archivo');
            const btnCamara = document.getElementById('btn-modo-camara');
            const btnArchivo = document.getElementById('btn-modo-archivo');
            const btnRegistrarText = document.getElementById('btn-registrar-text');
            
            if (modo === 'camara') {
                contenedorCamara.classList.remove('hidden');
                contenedorArchivo.classList.add('hidden');
                btnCamara.classList.add('bg-purple-600', 'text-white');
                btnCamara.classList.remove('text-gray-400');
                btnArchivo.classList.remove('bg-purple-600', 'text-white');
                btnArchivo.classList.add('text-gray-400');
                btnRegistrarText.textContent = 'Capturar y Registrar';
                
                // Iniciar c√°mara si no est√° activa
                if (!stream) {
                    iniciarCamara();
                }
            } else {
                contenedorCamara.classList.add('hidden');
                contenedorArchivo.classList.remove('hidden');
                btnArchivo.classList.add('bg-purple-600', 'text-white');
                btnArchivo.classList.remove('text-gray-400');
                btnCamara.classList.remove('bg-purple-600', 'text-white');
                btnCamara.classList.add('text-gray-400');
                btnRegistrarText.textContent = 'Registrar Foto';
                
                // Detener c√°mara si est√° activa
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }
        }
        
        // Procesar archivo seleccionado
        function procesarArchivo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    imagenCapturadaBase64 = e.target.result;
                    
                    // Mostrar preview
                    const preview = document.getElementById('preview-foto');
                    const imgPreview = document.getElementById('img-preview');
                    imgPreview.src = imagenCapturadaBase64;
                    preview.classList.remove('hidden');
                    
                    console.log('‚úì Foto cargada exitosamente');
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Verificar credenciales
        document.getElementById('formVerificacion').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const correo = document.getElementById('correo').value;
            const contrasena = document.getElementById('contrasena').value;
            
            try {
                const response = await fetch('/api/biometria/verificar-credenciales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ correo, contrasena })
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    idUsuarioVerificado = data.id_usuario;
                    
                    // Actualizar UI
                    document.getElementById('nombre-usuario').textContent = data.nombre_completo;
                    document.getElementById('correo-usuario').textContent = correo;
                    
                    // Cambiar a paso 2
                    avanzarAPaso(2);
                    
                    // Detectar si es m√≥vil
                    const esMobil = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (esMobil) {
                        // En m√≥vil, usar modo archivo por defecto (m√°s f√°cil)
                        cambiarModoCaptura('archivo');
                    } else {
                        // En PC, iniciar c√°mara
                        iniciarCamara();
                    }
                } else {
                    alert(data.mensaje || 'Credenciales incorrectas');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al verificar credenciales');
            }
        });
        
        // Avanzar al siguiente paso
        function avanzarAPaso(paso) {
            // Ocultar todas las secciones
            document.getElementById('seccion-verificacion').classList.add('hidden');
            document.getElementById('seccion-captura').classList.add('hidden');
            document.getElementById('seccion-exito').classList.add('hidden');
            
            // Mostrar la secci√≥n correspondiente
            if (paso === 2) {
                document.getElementById('seccion-captura').classList.remove('hidden');
                document.getElementById('step2').querySelector('div').classList.remove('bg-gray-600', 'text-gray-400');
                document.getElementById('step2').querySelector('div').classList.add('bg-purple-600', 'text-white');
                document.getElementById('progress-line-1').classList.add('bg-purple-600');
            } else if (paso === 3) {
                document.getElementById('seccion-exito').classList.remove('hidden');
                document.getElementById('step3').querySelector('div').classList.remove('bg-gray-600', 'text-gray-400');
                document.getElementById('step3').querySelector('div').classList.add('bg-green-600', 'text-white');
                document.getElementById('progress-line-2').classList.add('bg-green-600');
            }
        }
        
        // Iniciar c√°mara
        async function iniciarCamara() {
            const video = document.getElementById('video');
            const statusText = document.getElementById('status-text');
            const scanner = document.getElementById('scanner');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }
                });
                
                video.srcObject = stream;
                scanner.classList.remove('hidden');
                statusText.textContent = 'Posicione su rostro dentro del √≥valo';
                
            } catch (error) {
                console.error('Error:', error);
                statusText.textContent = '‚ùå No se pudo acceder a la c√°mara';
                statusText.classList.add('text-red-400');
            }
        }
        
        // Capturar y registrar rostro
        async function capturarYRegistrar() {
            if (!idUsuarioVerificado) {
                alert('Error: Usuario no verificado');
                return;
            }
            
            let imagenBase64 = null;
            const statusText = document.getElementById('status-text');
            const btnRegistrar = document.getElementById('btn-registrar');
            
            // Obtener imagen seg√∫n el modo
            if (modoCaptura === 'camara') {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                
                // Capturar imagen de la c√°mara
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                imagenBase64 = canvas.toDataURL('image/jpeg', 0.8);
            } else {
                // Usar imagen cargada desde archivo
                if (!imagenCapturadaBase64) {
                    alert('Por favor, selecciona o toma una foto primero');
                    return;
                }
                imagenBase64 = imagenCapturadaBase64;
            }
            
            // Deshabilitar bot√≥n
            btnRegistrar.disabled = true;
            btnRegistrar.innerHTML = `
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Procesando...
            `;
            statusText.textContent = 'Procesando imagen...';
            
            try {
                const response = await fetch('/api/biometria/registrar-rostro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_usuario: idUsuarioVerificado,
                        imagen_facial: imagenBase64
                    })
                });
                
                const data = await response.json();
                
                if (data.exito) {
                    // Detener c√°mara
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Mostrar √©xito
                    avanzarAPaso(3);
                } else {
                    statusText.textContent = '‚ùå ' + (data.mensaje || 'Error al registrar');
                    statusText.classList.add('text-red-400');
                    
                    // Rehabilitar bot√≥n
                    btnRegistrar.disabled = false;
                    btnRegistrar.innerHTML = `
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Reintentar
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                statusText.textContent = '‚ùå Error de conexi√≥n';
                btnRegistrar.disabled = false;
            }
        }
        
        // Cancelar y volver
        function cancelar() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            window.location.href = "{{ url_for('login') }}";
        }
        
        // Limpiar al salir
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>

