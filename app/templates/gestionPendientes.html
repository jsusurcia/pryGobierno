{% extends "sidebar.html" %}

{% block title %}Gestión de Incidentes Pendientes{% endblock %}

{% block nav_links %}
<li>
  <a href="{{ url_for('gestion_pendientes') }}" class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group bg-blue-50">
    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
    <span class="ms-3">Pendientes</span>
  </a>
</li>
<li>
  <a href="{{ url_for('gestion_incidentes') }}" class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
    <svg class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900" 
         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 21">
      <path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998 8.5 8.5 0 1 0 9.039 9.039.999.999 0 0 0-1-1.066h.002Z"/>
      <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0Z"/>
    </svg>
    <span class="ms-3">Todos los Incidentes</span>
  </a>
</li>
{% endblock nav_links %}

{% block content %}

<!-- Mensajes Flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="mb-4 p-4 rounded-lg 
          {% if category == 'error' %}bg-red-100 border border-red-200 text-red-700
          {% elif category == 'success' %}bg-green-100 border border-green-200 text-green-700
          {% elif category == 'info' %}bg-blue-100 border border-blue-200 text-blue-700
          {% else %}bg-yellow-100 border border-yellow-200 text-yellow-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="max-w-7xl mx-auto">
  
  <!-- Encabezado -->
  <header class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Incidentes Pendientes de Revisión</h1>
    <p class="text-gray-600 mt-2">Gestiona los incidentes reportados por los jefes de área</p>
  </header>

  <!-- Lista de Incidentes -->
  {% if incidentes %}
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Título</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reportado por</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for incidente in incidentes %}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              #{{ incidente.id_incidente }}
            </td>
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-gray-900">{{ incidente.titulo }}</div>
              <div class="text-sm text-gray-500 mt-1 line-clamp-2">{{ incidente.descripcion[:100] }}{% if incidente.descripcion|length > 100 %}...{% endif %}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                {{ incidente.categoria or 'Sin categoría' }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
              {{ incidente.reportado_por }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ incidente.fecha_reporte.strftime('%d/%m/%Y %H:%M') if incidente.fecha_reporte else 'N/A' }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-2">
                <button onclick="aceptarIncidente({{ incidente.id_incidente }})" 
                        class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded-lg hover:bg-green-700 transition">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Aceptar
                </button>
                <button onclick="cancelarIncidente({{ incidente.id_incidente }})" 
                        class="inline-flex items-center px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded-lg hover:bg-red-700 transition">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Cancelar
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
    <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay incidentes pendientes</h3>
    <p class="text-gray-500">Todos los incidentes han sido revisados</p>
  </div>
  {% endif %}

</div>

{% endblock content %}

{% block scripts %}
<script>
function aceptarIncidente(id) {
    if (!confirm('¿Está seguro de aceptar este incidente?')) return;
    
    fetch(`/api/incidente/${id}/aceptar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = `/asignar_prioridad/${id}`;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar la solicitud');
    });
}

function cancelarIncidente(id) {
    if (!confirm('¿Está seguro de cancelar este incidente? Esta acción no se puede deshacer.')) return;
    
    fetch(`/api/incidente/${id}/cancelar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar la solicitud');
    });
}
</script>
{% endblock scripts %}

