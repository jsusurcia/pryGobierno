{% extends "sidebar.html" %}

{% block title %}Asignar Técnicos{% endblock %}

{% block nav_links %}
<li>
  <a href="{{ url_for('gestion_pendientes') }}" class="flex items-center p-2 text-gray-900 rounded-lg hover:bg-gray-100 group">
    <svg class="w-5 h-5 text-gray-500 transition duration-75 group-hover:text-gray-900" 
         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 21">
      <path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998 8.5 8.5 0 1 0 9.039 9.039.999.999 0 0 0-1-1.066h.002Z"/>
      <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0Z"/>
    </svg>
    <span class="ms-3">Pendientes</span>
  </a>
</li>
{% endblock nav_links %}

{% block content %}

<!-- Mensajes Flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="mb-4 p-4 rounded-lg 
          {% if category == 'error' %}bg-red-100 border border-red-200 text-red-700
          {% elif category == 'success' %}bg-green-100 border border-green-200 text-green-700
          {% else %}bg-yellow-100 border border-yellow-200 text-yellow-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="max-w-5xl mx-auto">
  
  <!-- Encabezado -->
  <header class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Asignar Técnicos</h1>
    <p class="text-gray-600 mt-2">Asigna técnico(s) al incidente #{{ incidente.id_incidente }} - Nivel: 
      <span class="font-semibold {% if incidente.nivel == 'C' %}text-red-600{% elif incidente.nivel == 'A' %}text-orange-600{% endif %}">
        {{ 'Crítico' if incidente.nivel == 'C' else 'Alto' }}
      </span>
    </p>
  </header>

  <!-- Información del Incidente -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Detalles del Incidente</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <span class="text-sm font-medium text-gray-500">Título:</span>
        <p class="text-gray-900">{{ incidente.titulo }}</p>
      </div>
      <div>
        <span class="text-sm font-medium text-gray-500">Nivel:</span>
        <span class="px-2 py-1 text-xs font-semibold rounded-full 
          {% if incidente.nivel == 'C' %}bg-red-100 text-red-800
          {% elif incidente.nivel == 'A' %}bg-orange-100 text-orange-800{% endif %}">
          {{ 'Crítico' if incidente.nivel == 'C' else 'Alto' }}
        </span>
      </div>
      <div class="md:col-span-2">
        <span class="text-sm font-medium text-gray-500">Descripción:</span>
        <p class="text-gray-700">{{ incidente.descripcion }}</p>
      </div>
    </div>
  </div>

  <!-- Equipo Actual -->
  {% if equipo_actual %}
  <div class="bg-blue-50 rounded-xl border border-blue-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-blue-900 mb-4">Equipo Actualmente Asignado</h3>
    <div class="space-y-2">
      {% for miembro in equipo_actual %}
      <div class="flex items-center justify-between bg-white rounded-lg p-3">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
            <span class="text-blue-600 font-semibold">{{ miembro.nombre_completo[0] }}</span>
          </div>
          <div>
            <p class="font-medium text-gray-900">{{ miembro.nombre_completo }}</p>
            {% if miembro.es_responsable %}
            <span class="text-xs text-blue-600 font-medium">Responsable</span>
            {% endif %}
          </div>
        </div>
        <span class="text-xs text-gray-500">{{ miembro.fecha_asignacion.strftime('%d/%m/%Y') if miembro.fecha_asignacion else '' }}</span>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Formulario de Asignación -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-6">Nueva Asignación</h2>
    
    <form method="POST" action="{{ url_for('asignar_tecnicos', id_incidente=incidente.id_incidente) }}" id="formAsignacion">
      
      <!-- Tipo de Asignación -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-3">Tipo de Asignación</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="relative flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition">
            <input type="radio" name="tipo_asignacion" value="individual" class="sr-only peer" required onchange="toggleTipoAsignacion()">
            <div class="flex-1">
              <div class="font-semibold text-gray-900 mb-1">Individual</div>
              <p class="text-sm text-gray-600">Asignar un solo técnico como responsable</p>
            </div>
            <div class="ml-4 w-6 h-6 border-2 border-gray-300 rounded-full peer-checked:border-blue-600 peer-checked:bg-blue-600 flex items-center justify-center">
              <div class="w-3 h-3 bg-white rounded-full hidden peer-checked:block"></div>
            </div>
          </label>
          
          <label class="relative flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition">
            <input type="radio" name="tipo_asignacion" value="grupo" class="sr-only peer" required onchange="toggleTipoAsignacion()">
            <div class="flex-1">
              <div class="font-semibold text-gray-900 mb-1">Grupo</div>
              <p class="text-sm text-gray-600">Asignar múltiples técnicos con un responsable</p>
            </div>
            <div class="ml-4 w-6 h-6 border-2 border-gray-300 rounded-full peer-checked:border-blue-600 peer-checked:bg-blue-600 flex items-center justify-center">
              <div class="w-3 h-3 bg-white rounded-full hidden peer-checked:block"></div>
            </div>
          </label>
        </div>
      </div>

      <!-- Asignación Individual -->
      <div id="asignacionIndividual" class="hidden mb-6">
        <label for="id_tecnico" class="block text-sm font-medium text-gray-700 mb-2">
          Seleccionar Técnico <span class="text-red-500">*</span>
        </label>
        <select name="id_tecnico" id="id_tecnico" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">-- Seleccione un técnico --</option>
          {% for tecnico in tecnicos %}
          <option value="{{ tecnico.id_usuario }}">{{ tecnico.nombre_completo }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Asignación en Grupo -->
      <div id="asignacionGrupo" class="hidden mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-3">
          Seleccionar Técnicos <span class="text-red-500">*</span>
        </label>
        <div class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto border border-gray-200">
          {% for tecnico in tecnicos %}
          <label class="flex items-center p-3 mb-2 bg-white rounded-lg hover:bg-blue-50 cursor-pointer border border-gray-200">
            <input type="checkbox" name="tecnicos[]" value="{{ tecnico.id_usuario }}" 
                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                   onchange="updateResponsableOptions()">
            <span class="ml-3 text-gray-900">{{ tecnico.nombre_completo }}</span>
          </label>
          {% endfor %}
        </div>
        
        <div class="mt-4">
          <label for="responsable" class="block text-sm font-medium text-gray-700 mb-2">
            Seleccionar Responsable <span class="text-red-500">*</span>
          </label>
          <select name="responsable" id="responsable" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            <option value="">-- Seleccione el responsable --</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">El responsable debe estar entre los técnicos seleccionados</p>
        </div>
      </div>

      <!-- Botones -->
      <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
        <a href="{{ url_for('gestion_pendientes') }}" 
           class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition font-medium">
          Cancelar
        </a>
        <button type="submit" 
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
          Asignar Técnico(s)
        </button>
      </div>

    </form>
  </div>

</div>

{% endblock content %}

{% block scripts %}
<script>
function toggleTipoAsignacion() {
    const individual = document.getElementById('asignacionIndividual');
    const grupo = document.getElementById('asignacionGrupo');
    const tipoIndividual = document.querySelector('input[value="individual"]');
    const tipoGrupo = document.querySelector('input[value="grupo"]');
    
    if (tipoIndividual.checked) {
        individual.classList.remove('hidden');
        grupo.classList.add('hidden');
        document.getElementById('id_tecnico').required = true;
        document.getElementById('responsable').required = false;
    } else if (tipoGrupo.checked) {
        individual.classList.add('hidden');
        grupo.classList.remove('hidden');
        document.getElementById('id_tecnico').required = false;
        document.getElementById('responsable').required = true;
    }
}

function updateResponsableOptions() {
    const responsableSelect = document.getElementById('responsable');
    const checkboxes = document.querySelectorAll('input[name="tecnicos[]"]:checked');
    
    // Limpiar opciones
    responsableSelect.innerHTML = '<option value="">-- Seleccione el responsable --</option>';
    
    // Agregar opciones de los técnicos seleccionados
    checkboxes.forEach(checkbox => {
        const option = document.createElement('option');
        option.value = checkbox.value;
        option.textContent = checkbox.closest('label').querySelector('span').textContent;
        responsableSelect.appendChild(option);
    });
    
    // Si solo hay uno seleccionado, seleccionarlo automáticamente
    if (checkboxes.length === 1) {
        responsableSelect.value = checkboxes[0].value;
    }
}

// Validación del formulario
document.getElementById('formAsignacion').addEventListener('submit', function(e) {
    const tipoIndividual = document.querySelector('input[value="individual"]');
    const tipoGrupo = document.querySelector('input[value="grupo"]');
    
    if (tipoIndividual.checked) {
        const tecnico = document.getElementById('id_tecnico').value;
        if (!tecnico) {
            e.preventDefault();
            alert('Por favor seleccione un técnico');
            return false;
        }
    } else if (tipoGrupo.checked) {
        const tecnicos = document.querySelectorAll('input[name="tecnicos[]"]:checked');
        const responsable = document.getElementById('responsable').value;
        
        if (tecnicos.length === 0) {
            e.preventDefault();
            alert('Por favor seleccione al menos un técnico');
            return false;
        }
        
        if (!responsable) {
            e.preventDefault();
            alert('Por favor seleccione un responsable');
            return false;
        }
    }
});
</script>
{% endblock scripts %}

